@using Radiostanciya.Models
@using Radiostanciya.ViewModels
@using Radiostanciya.ViewModels.EmployeeViewModels
@model IndexViewModel
@addTagHelper "*, Radiostanciya"
@{
    ViewData["Title"] = "Сотрудники";
}
<h1>Список сотрудников</h1>
<form method="get">
    <div class="form-inline">
        @*<label class="control-label">Номер: </label>
        @Html.TextBox("Id", Model.IndexViewModel.SelectedId, htmlAttributes: new { @class = "form-control" })*@

        <label class="control-label">Название: </label>
        @Html.TextBox("Name", Model.FilterViewModel.SelectedName,
                htmlAttributes: new { @class = "form-control" })

        <label class="control-label">Должность: </label>
        @Html.TextBox("Pos", Model.FilterViewModel.SelectedName,
                htmlAttributes: new { @class = "form-control" })

        <input type="submit" value="Поиск" class="btn btn-default" />
    </div>
</form>
<br />
<div class="cell">
    <table class="table" id="data">
        <thead>
            <tr>
                <th>
                    <a asp-action="Index"
                       asp-route-sortOrder="@(Model.SortViewModel.IdSort)"
                       asp-route-name="@(Model.FilterViewModel.SelectedName)"
                       asp-route-Organization="@(Model.FilterViewModel.SelectedId)">Номер</a>
                </th>
                <th>
                    <a asp-action="Index" asp-route-sortOrder="@(Model.SortViewModel.NameSort)"
                       asp-route-name="@(Model.FilterViewModel.SelectedName)"
                       asp-route-Organization="@(Model.FilterViewModel.SelectedId)">ФИО</a>
                </th>
                <th>
                    <a asp-action="Index" asp-route-sortOrder="@(Model.SortViewModel.AgeSort)"
                       asp-route-name="@(Model.FilterViewModel.SelectedName)"
                       asp-route-Organization="@(Model.FilterViewModel.SelectedId)">Возраст</a>
                </th>
                <th>
                    Пол
                </th>
                <th>
                    Адресс
                </th>
                <th>
                    Пасспорт
                </th>
                <th>
                    <a asp-action="Index" asp-route-sortOrder="@(Model.SortViewModel.PositionSort)"
                       asp-route-name="@(Model.FilterViewModel.SelectedName)"
                       asp-route-Organization="@(Model.FilterViewModel.SelectedId)">Должность</a>
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (Employee u in Model.Employees)
            {
                <tr><td>@u.Id</td><td>@u.Name</td><td>@u.Age</td><td>@u.Sex</td><td>@u.Address</td><td>@u.Passport</td><td>@Model.Positions.First(p => p.Id ==u.PositionId).Name</td></tr>
            }
        </tbody>
    </table>
    <page-link page-model="@Model.PageViewModel" page-action="Index"
               page-url-name="@(Model.FilterViewModel.SelectedName)"
               page-url-company="@(Model.FilterViewModel.SelectedId)"
               page-url-sortorder="@(Model.SortViewModel.Current)"></page-link>
</div>
<form name="edit" class="cell">
    <h3>Редактирование данных</h3><br />
                                  <table class="table">
                                      <tr>
                                          <td><label class="control-label">Номер</label></td>
                                          <td colspan="2"><input type="text" name="number" readonly class="form-control" /></td>
                                      </tr>
                                      <tr>
                                          <td><label class="control-label">Название</label></td>
                                          <td colspan="2"><input type="text" name="name" class="form-control" /></td>
                                      </tr>
                                      <tr>
                                          <td><label class="control-label">Возаст</label></td>
                                          <td colspan="2"><input type="text" name="age" class="form-control" /></td>
                                      </tr>
                                      <tr>
                                          <td><label class="control-label">Пол</label></td>
                                          <td colspan="2"><input type="text" name="sex" class="form-control" /></td>
                                      </tr>
                                      <tr>
                                          <td><label class="control-label">Адрес</label></td>
                                          <td colspan="2"><input type="text" name="address" class="form-control" /></td>
                                      </tr>
                                      <tr>
                                          <td><label class="control-label">Паспорт</label></td>
                                          <td colspan="2"><input type="text" name="passport" class="form-control" /></td>
                                      </tr>
                                      <tr>
                                          <td><label class="control-label">Должность</label></td>
                                          <td colspan="2">
                                              <select name="pos">
                                                  @foreach (Position b in Model.Positions)
                                                  {
                                                      <option id="@b.Id">@b.Name</option>
                                                  }
                                              </select>
                                          </td>
                                      </tr>
                                      <tr>
                                          <td><input type="button" name="add" value="Добавить" class="btn btn-default" /></td>
                                          <td><input type="button" name="del" value="Удалить" class="btn btn-default" /></td>
                                          <td><input type="button" name="upd" value="Обновить" class="btn btn-default" /></td>
                                      </tr>
                                  </table>
    <div id="msg_display"></div>
</form>
<script type="text/javascript">
    $(function () {
        function setSelectedRecord() {
            var selectedId = localStorage.getItem('selectedEmployeeId');
            if (selectedId) {
                var selectedRow = $('#data tbody tr').filter(function () {
                    return $(this).children('td')[0].textContent === selectedId;
                });
                if (selectedRow.length > 0) {
                    selectedRow.addClass('selected');
                    updateFormFields(selectedRow);
                }
            }
        }

        function updateFormFields(selectedRow) {
            $('input[name=number]').val(selectedRow.children('td')[0].textContent);
            $('input[name=name]').val(selectedRow.children('td')[1].textContent);
            $('input[name=age]').val(selectedRow.children('td')[2].textContent);
            $('input[name=sex]').val(selectedRow.children('td')[3].textContent);
            $('input[name=address]').val(selectedRow.children('td')[4].textContent);
            $('input[name=passport]').val(selectedRow.children('td')[5].textContent);
            $('select[name=pos]').val(selectedRow.children('td')[6].textContent);
        }

        setSelectedRecord();

        $('#data tbody tr').click(function () {
            $('#data tbody tr').removeClass('selected');
            updateFormFields($(this));
            $(this).addClass('selected');
            localStorage.setItem('selectedEmployeeId', $(this).children('td')[0].textContent);
        });

        $('input[name=add]').click(function () {
            $.getJSON('/Employees/Insert?name=' + $('input[name=name]').val() +
                '&age=' + $('input[name=age]').val() +
                '&sex=' + $('input[name=sex]').val() +
                '&address=' + $('input[name=address]').val() +
                '&passport=' + $('input[name=passport]').val() +
                '&posId=' + $('select[name=pos]').find(":selected").attr("id")
                , null);
            getMsg('Добавлено');
        });

        $('input[name=del]').click(function () {
            $.getJSON('/Employees/Delete?id=' + $('input[name=number]').val(), null);
            $('.selected').remove();
            getMsg('Удалено');
        });

        $('input[name=upd]').click(function () {
            $.getJSON('/Employees/Update?id=' + $('input[name=number]').val() + '&name=' + $('input[name=name]').val() +
                '&age=' + $('input[name=age]').val() +
                '&sex=' + $('input[name=sex]').val() +
                '&address=' + $('input[name=address]').val() +
                '&passport=' + $('input[name=passport]').val() +
                '&posId=' + $('select[name=pos]').find(":selected").attr("id"), null);
            $('.selected').children('td')[1].textContent = $('input[name=name]').val();
            $('.selected').children('td')[2].textContent = $('input[name=age]').val();
            $('.selected').children('td')[3].textContent = $('input[name=sex]').val();
            $('.selected').children('td')[4].textContent = $('input[name=address]').val();
            $('.selected').children('td')[5].textContent = $('input[name=passport]').val();
            $('.selected').children('td')[6].textContent = $('select[name=pos]').val();
            getMsg('Обновлено');
        });

        function getMsg(msg) {
            if (msg == undefined)
                msg = 'Ошибка';
            $('#msg_display').text(msg);
            $('#msg_display').css('display', 'block');
            $('#msg_display').fadeOut(2000, function () {
                $('#msg_display').css('display', 'none');
            });
        }
    });
</script>


